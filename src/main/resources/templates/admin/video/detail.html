<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout/layout}"
      layout:fragment="content">
<body>

<main class="p-12">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="/" class="inline-flex items-center text-gray-600 hover:text-gray-900">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            목록으로
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Video Player -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="aspect-video bg-black">
                    <video th:id="'video-' + ${video.id}"
                           class="w-full h-full"
                           controls
                           th:poster="${video.thumbnailFilename} ? @{'/uploads/video/thumbnails/' + ${video.thumbnailFilename}} : ''">
                        <source th:src="@{'/uploads/video/videos/' + ${video.storedFilename}}"
                                th:type="${video.contentType}">
                        <source th:if="${video.convertedFilename}"
                                th:src="@{'/uploads/videos/converted/' + ${video.convertedFilename}}"
                                type="video/mp4">
                        브라우저가 비디오 태그를 지원하지 않습니다.
                    </video>
                </div>
                <div class="p-4">
                    <h1 class="text-xl font-bold text-gray-900" th:text="${video.originalFilename}">filename.mp4</h1>
                    <p class="text-sm text-gray-500 mt-1">
                        업로드: <span th:text="${#temporals.format(video.createdAt, 'yyyy년 MM월 dd일 HH:mm')}"></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Video Info & Actions -->
        <div class="space-y-6">

            <!-- Status Card -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="font-semibold text-gray-900 mb-3">상태</h2>
                <div class="flex items-center space-x-2">
                    <span th:switch="${video.status.name()}">
                        <span th:case="'COMPLETED'" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            처리 완료
                        </span>
                        <span th:case="'PROCESSING'" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                            <svg class="w-4 h-4 mr-1 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            처리 중
                        </span>
                        <span th:case="'ERROR'" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            오류
                        </span>
                        <span th:case="*" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800" th:text="${video.status}">
                            상태
                        </span>
                    </span>
                </div>
                <p th:if="${video.errorMessage}" class="mt-2 text-sm text-red-600" th:text="${video.errorMessage}"></p>
            </div>

            <!-- Metadata Card -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="font-semibold text-gray-900 mb-3">비디오 정보</h2>
                <dl class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <dt class="text-gray-500">파일 크기</dt>
                        <dd class="text-gray-900 font-medium" th:text="${video.formattedFileSize}">0 MB</dd>
                    </div>
                    <div class="flex justify-between" th:if="${video.duration}">
                        <dt class="text-gray-500">재생 시간</dt>
                        <dd class="text-gray-900 font-medium" th:text="${video.formattedDuration}">00:00:00</dd>
                    </div>
                    <div class="flex justify-between" th:if="${video.width}">
                        <dt class="text-gray-500">해상도</dt>
                        <dd class="text-gray-900 font-medium" th:text="${video.resolution}">1920x1080</dd>
                    </div>
                    <div class="flex justify-between" th:if="${video.codec}">
                        <dt class="text-gray-500">코덱</dt>
                        <dd class="text-gray-900 font-medium" th:text="${video.codec}">h264</dd>
                    </div>
                    <div class="flex justify-between" th:if="${video.bitrate}">
                        <dt class="text-gray-500">비트레이트</dt>
                        <dd class="text-gray-900 font-medium" th:text="${#numbers.formatDecimal(video.bitrate / 1000000.0, 1, 2) + ' Mbps'}">0 Mbps</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-500">타입</dt>
                        <dd class="text-gray-900 font-medium" th:text="${video.contentType}">video/mp4</dd>
                    </div>
                </dl>
            </div>

            <!-- Actions Card -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="font-semibold text-gray-900 mb-3">작업</h2>
                <div class="space-y-2">

                    <!-- MP4 변환 -->
                    <button th:id="'convertBtn-' + ${video.id}"
                            th:data-id="${video.id}"
                            th:disabled="${video.convertedFilename != null}"
                            onclick="convertVideo(this)"
                            class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span th:text="${video.convertedFilename != null} ? '변환 완료' : 'MP4 변환'">MP4 변환</span>
                    </button>

                    <!-- 다운로드 -->
                    <a th:href="@{'/uploads/videos/' + ${video.storedFilename}}"
                       th:download="${video.originalFilename}"
                       class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        원본 다운로드
                    </a>

                    <!-- 변환 파일 다운로드 -->
                    <a th:if="${video.convertedFilename}"
                       th:href="@{'/uploads/video/converted/' + ${video.convertedFilename}}"
                       download
                       class="w-full flex items-center justify-center px-4 py-2 border border-green-300 rounded-md text-sm font-medium text-green-700 bg-green-50 hover:bg-green-100">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        변환 파일 다운로드
                    </a>

                    <hr class="my-3">

                    <!-- 삭제 -->
                    <button th:data-id="${video.id}"
                            onclick="deleteVideo(this)"
                            class="w-full flex items-center justify-center px-4 py-2 border border-red-300 rounded-md text-sm font-medium text-red-700 bg-red-50 hover:bg-red-100">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        삭제
                    </button>
                </div>
            </div>

            <!-- Thumbnail Card -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="font-semibold text-gray-900 mb-3">썸네일 설정</h2>

                <!-- 현재 썸네일 정보 -->
                <div th:if="${video.thumbnailFilename}" class="mb-4">
                    <div class="aspect-video bg-gray-100 rounded-lg overflow-hidden mb-2">
                        <img th:src="@{'/uploads/video/thumbnails/' + ${video.thumbnailFilename}}"
                             class="w-full h-full object-cover" alt="현재 썸네일">
                    </div>
                    <div class="flex items-center justify-between">
                        <p class="text-sm text-gray-500">
                            <span th:if="${video.thumbnailType == 'AUTO'}" class="inline-flex items-center text-blue-600">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                자동 생성
                            </span>
                            <span th:if="${video.thumbnailType == 'MANUAL'}" class="inline-flex items-center text-green-600">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                </svg>
                                수동 업로드
                            </span>
                        </p>
                        <button onclick="deleteThumbnail()"
                                class="text-red-500 hover:text-red-700 text-sm">
                            삭제
                        </button>
                    </div>
                </div>

                <!-- 썸네일 없음 -->
                <div th:unless="${video.thumbnailFilename}" class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
                    <svg class="mx-auto h-8 w-8 text-yellow-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p class="text-sm text-yellow-700">썸네일이 없습니다</p>
                </div>

                <!-- 썸네일 생성 방식 선택 -->
                <div class="space-y-3">
                    <!-- 자동 생성 버튼 -->
                    <button th:data-id="${video.id}"
                            onclick="generateThumbnailAuto(this)"
                            class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        자동 생성 (영상에서 추출)
                    </button>

                    <!-- 수동 업로드 섹션 -->
                    <div class="border border-gray-200 rounded-lg p-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">수동 업로드 (이미지 파일)</p>

                        <!-- 파일 선택 영역 -->
                        <div id="thumbnailUploadZone"
                             class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors">
                            <input type="file" id="thumbnailFileInput" accept="image/*" class="hidden">
                            <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-sm text-gray-500">클릭하여 이미지 선택</p>
                            <p class="text-xs text-gray-400 mt-1">JPG, PNG, GIF, WEBP</p>
                        </div>

                        <!-- 선택된 파일 미리보기 -->
                        <div id="thumbnailPreview" class="hidden mt-3">
                            <div class="flex items-center space-x-3">
                                <img id="thumbnailPreviewImg" class="w-20 h-12 object-cover rounded" src="" alt="미리보기">
                                <div class="flex-1">
                                    <p id="thumbnailFileName" class="text-sm text-gray-700 truncate">filename.jpg</p>
                                    <p id="thumbnailFileSize" class="text-xs text-gray-500">0 KB</p>
                                </div>
                                <button onclick="clearThumbnailFile()" class="text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <button onclick="uploadThumbnailFile()"
                                    class="w-full mt-3 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-md">
                                썸네일 업로드
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>
<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 hidden">
    <div id="toast-content" class="px-6 py-3 rounded-lg shadow-lg">
        <span id="toast-message"></span>
    </div>
</div>

<script th:inline="javascript">
    const videoId = [[${video.id}]];

    // 썸네일 업로드 관련 요소
    const thumbnailUploadZone = document.getElementById('thumbnailUploadZone');
    const thumbnailFileInput = document.getElementById('thumbnailFileInput');
    const thumbnailPreview = document.getElementById('thumbnailPreview');
    const thumbnailPreviewImg = document.getElementById('thumbnailPreviewImg');
    const thumbnailFileName = document.getElementById('thumbnailFileName');
    const thumbnailFileSize = document.getElementById('thumbnailFileSize');

    let selectedThumbnailFile = null;

    // 썸네일 업로드 영역 클릭
    thumbnailUploadZone.addEventListener('click', () => {
        thumbnailFileInput.click();
    });

    // 파일 선택 시
    thumbnailFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleThumbnailFile(e.target.files[0]);
        }
    });

    // 드래그 앤 드롭
    thumbnailUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        thumbnailUploadZone.classList.add('border-blue-400', 'bg-blue-50');
    });

    thumbnailUploadZone.addEventListener('dragleave', () => {
        thumbnailUploadZone.classList.remove('border-blue-400', 'bg-blue-50');
    });

    thumbnailUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        thumbnailUploadZone.classList.remove('border-blue-400', 'bg-blue-50');
        if (e.dataTransfer.files.length > 0) {
            handleThumbnailFile(e.dataTransfer.files[0]);
        }
    });

    // 썸네일 파일 처리
    function handleThumbnailFile(file) {
        if (!file.type.startsWith('image/')) {
            showToast('이미지 파일만 업로드 가능합니다.', 'error');
            return;
        }

        selectedThumbnailFile = file;

        // 미리보기 표시
        const reader = new FileReader();
        reader.onload = (e) => {
            thumbnailPreviewImg.src = e.target.result;
        };
        reader.readAsDataURL(file);

        thumbnailFileName.textContent = file.name;
        thumbnailFileSize.textContent = formatFileSize(file.size);
        thumbnailPreview.classList.remove('hidden');
    }

    // 선택 취소
    function clearThumbnailFile() {
        selectedThumbnailFile = null;
        thumbnailFileInput.value = '';
        thumbnailPreview.classList.add('hidden');
    }

    // 썸네일 업로드
    async function uploadThumbnailFile() {
        if (!selectedThumbnailFile) {
            showToast('파일을 선택해주세요.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', selectedThumbnailFile);

        try {
            const response = await fetch(`/api/videos/${videoId}/thumbnail/upload`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                showToast('썸네일 업로드 완료!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('오류 발생: ' + error.message, 'error');
        }
    }

    // 자동 생성
    async function generateThumbnailAuto(btn) {
        btn.disabled = true;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">' +
            '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">' +
            '</circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>생성 중...';

        try {
            const response = await fetch(`/api/videos/${videoId}/thumbnail/auto`, { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                showToast('썸네일 자동 생성 완료!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('오류 발생: ' + error.message, 'error');
        }

        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }

    // 썸네일 삭제
    async function deleteThumbnail() {
        if (!confirm('썸네일을 삭제하시겠습니까?')) return;

        try {
            const response = await fetch(`/api/videos/${videoId}/thumbnail`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                showToast('썸네일 삭제 완료!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('오류 발생: ' + error.message, 'error');
        }
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const content = document.getElementById('toast-content');
        const msg = document.getElementById('toast-message');

        msg.textContent = message;
        content.className = `px-6 py-3 rounded-lg shadow-lg ${
            type === 'success' ? 'bg-green-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'
        }`;

        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    async function convertVideo(btn) {
        const id = btn.dataset.id;
        btn.disabled = true;
        btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>변환 중...';

        try {
            const response = await fetch(`/api/videos/${id}/convert`, { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                showToast('변환 완료!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>MP4 변환';
            }
        } catch (error) {
            showToast('오류 발생: ' + error.message, 'error');
            btn.disabled = false;
        }
    }

    async function deleteVideo(btn) {
        if (!confirm('정말 삭제하시겠습니까?')) return;

        const id = btn.dataset.id;
        btn.disabled = true;

        try {
            const response = await fetch(`/api/videos/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                showToast('삭제 완료!', 'success');
                setTimeout(() => location.href = '/', 1500);
            } else {
                showToast(result.message, 'error');
                btn.disabled = false;
            }
        } catch (error) {
            showToast('오류 발생: ' + error.message, 'error');
            btn.disabled = false;
        }
    }
</script>
</body>
</html>